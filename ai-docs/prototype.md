# Parrot — Worker-First Prototype (aligned with current repo)
---

## 0) What we already have

- `src/index.ts` — Hono entry wiring `/` and `/api/config`.
- `src/routes/api/config.ts` — exchanges `ANAM_API_KEY` + `ANAM_AVATAR_ID` for an Anam session token and returns `ELEVENLABS_AGENT_ID`.
- `src/client.ts` — orchestrates page: fetches config, starts Anam video, pipes ElevenLabs audio into `createAgentAudioInputStream`, renders transcript.
- `src/elevenlabs.ts` — WebSocket to ElevenLabs ConvAI + mic capture via `chatdio`; handles audio, transcripts, barge-in, ping/pong.
- `src/routes/index.tsx` — SSR UI (connect button, transcript, avatar viewport).
- `src/style.css` — Tailwind 4 tokens + animations.

**Not present yet:** Convex, n8n, CodeRabbit ingestion. To move fast, extend the existing worker/app instead of introducing new stacks.

---

## 1) Updated prototype goal

Keep the current ElevenLabs + Anam demo flow, but inject a CodeRabbit report so the agent answers PM questions about project status.

---

## 2) Minimal additions that reuse existing code

1. **Expose a report endpoint in the worker**
   - Add `src/routes/api/report.ts` that returns a latest report JSON.
   - Wire `app.get("/api/report", Report)` in `src/index.ts`.
   - Source options (pick one per environment):
     - Static: drop `public/report.json` generated by n8n.
     - Remote: fetch from `REPORT_SOURCE_URL` (env) that serves the latest CodeRabbit summary.

2. **Send context to ElevenLabs using the existing socket**
   - Extend `connectElevenLabs(agentId, callbacks, contextText?)`.
   - On `websocket.onopen`, after mic setup, send:
     ```ts
     if (contextText) {
       websocket.send(JSON.stringify({ type: "contextual_update", text: contextText }));
     }
     ```

3. **Fetch + display the report in the current client**
   - In `src/client.ts` before `connectElevenLabs`, fetch `/api/report`.
   - Show a summary panel in the UI (reuse Tailwind utilities already in `src/routes/index.tsx`).
   - Pass `buildContextText(report)` into `connectElevenLabs`.

4. **Keep Anam passthrough exactly as-is**
   - Continue streaming ElevenLabs PCM16 into `createAgentAudioInputStream`.

---

## 3) Data contract for `/api/report`

```json
{
  "projectId": "org/repo",
  "projectName": "Parrot",
  "from": "2025-01-10",
  "to": "2025-01-11",
  "summary": "### PRs merged\n- ...",
  "raw": { "groups": [/* optional CodeRabbit response */] }
}
```

Keep fields small (summary ≤ 8k chars) because we send them over WebSocket as context.

---

## 4) Suggested code touchpoints

- **New route** `src/routes/api/report.ts`
  ```ts
  import { Context } from "hono";

  export const Report = async (c: Context) => {
    const source = c.env.REPORT_SOURCE_URL;
    try {
      const res = source
        ? await fetch(source)
        : await fetch(new URL("/public/report.json", c.req.url));
      if (!res.ok) return c.json({ error: "Report fetch failed" }, 500);
      const report = await res.json();
      return c.json(report);
    } catch (err) {
      console.error("Report error:", err);
      return c.json({ error: "Report unavailable" }, 500);
    }
  };
  ```

- **ElevenLabs context injection** `src/elevenlabs.ts`
  ```ts
  export async function connectElevenLabs(
    agentId: string,
    callbacks: ElevenLabsCallbacks,
    contextText?: string
  ) {
    // ...
    websocket.onopen = async () => {
      await setupMicrophone();
      if (contextText) {
        websocket.send(JSON.stringify({ type: "contextual_update", text: contextText }));
      }
      callbacks.onReady?.();
    };
    // ...
  }
  ```

- **Client orchestration** `src/client.ts`
  ```ts
  async function fetchReport() {
    const res = await fetch("/api/report");
    if (!res.ok) throw new Error("Failed to load report");
    return res.json();
  }

  function buildContextText(report) {
    if (!report) return "";
    return [
      "CodeRabbit project report:",
      `Project: ${report.projectName}`,
      `Window: ${report.from} → ${report.to}`,
      "",
      report.summary,
    ].join("\n");
  }

  async function start() {
    const [config, report] = await Promise.all([getConfig(), fetchReport()]);
    // existing Anam setup...
    await connectElevenLabs(config.elevenLabsAgentId, callbacks, buildContextText(report));
  }
  ```

- **UI** `src/routes/index.tsx`
  - Add a small panel above the transcript:
    ```
    <div id="report" class="...">Latest CodeRabbit summary will render here</div>
    ```
  - Populate it from `src/client.ts` once `/api/report` resolves.

---

## 5) Optional future steps (after demo)

- Swap the static/URL report source for Convex + n8n once needed.
- Add project switcher only after we have multiple report sources wired.
- Push transcripts to a persistent store; currently transcript is client-only.

---

## 6) Environment variables

- Already used: `ANAM_API_KEY`, `ANAM_AVATAR_ID`, `ELEVENLABS_AGENT_ID`.
- New (optional): `REPORT_SOURCE_URL` — points to the latest CodeRabbit summary JSON.

---

## 7) Demo checklist

- `.dev.vars` has the three required keys.
- `public/report.json` exists **or** `REPORT_SOURCE_URL` is set.
- `bun run dev` → open `http://localhost:5173`, click **Start Conversation**.
- Agent answers using report details; transcript shows both sides; avatar lip-syncs. 
